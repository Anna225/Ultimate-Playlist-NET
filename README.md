# Introduction 

Ultimate Payout Backend.

# Instances

- Mobile API
- Admin API

# Technology

-   Core: .Net Core 6.0
-   DB: MS SQL
-   ORM: EF Core 6.0.1
-   API: Swagger at `\swagger` (hidden by default, see below)
-   Logging: Serilog writing to file, console, Application Insights and AzureBlobStorage
-   BackgroundJobs:  Hangfire at `\hangfire` (hidden by default)

# Rest of technology

- AutoMapper - class mapper (https://automapper.org)
- CsvHelper - read/write to csv (https://joshclose.github.io/CsvHelper)
- FluentValidation - input/rules validation (https://fluentvalidation.net)
- Flurl - http client (https://flurl.dev)
- Moq - mocking framework (https://github.com/moq/moq4)
- xunit - testing framework (https://github.com/xunit/xunit)
- SendGrid - email sender (https://sendgrid.com)
- Google firebase - notifications and deeplinks (https://firebase.google.com/docs)
- Azure media services - azure service to process audio tracks (https://azure.microsoft.com/en-us/services/media-services)
- Spotify - connection to Spotify API (https://developer.spotify.com/documentation)
- Apple music - connection to Apple music API (https://developer.apple.com/documentation/applemusicapi)
- Redis - cache (https://redis.io/documentation)

# Repository

Repository is split into Full repository and read only repository where entities are returned as no tracking
Both repository types are based on specification:
For Include relations in specification:
```
        public UserSpecification WithAvatar()
        {
            AddInclude(s => s.AvatarFile);
            return this;
        }
```
For search
```
        private void ApplySearch(string searchValue)
        {
            if (!string.IsNullOrEmpty(searchValue))
            {
                AddCriteria(c =>
                     c.Name.ToLower().Contains(searchValue.ToLower())
                     || c.Code.ToLower().Contains(searchValue.ToLower()));
            }
        }
```
and inject in startup
```
    services.AddScoped(typeof(IRepository<UnitEntity>), typeof(Repository));
    services.AddScoped(typeof(IReadOnlyRepository<UnitEntity>), typeof(ReadOnlyRepository));
```
# Migrations

VS
```
Add-Migration <name> -Project UltimatePlaylist.Database.Migrations
or use UltimatePlaylist.Database.Migrations as subject in package manager console
```

CLI
```
dotnet ef migrations add <name> --project UltimatePlaylist.Database.Migrations

```

# Configuration

When deployed, API requires additional configuration (e.g. using Configuration section on Azure or secrets.json when locally). 
Keys listed below correspond to paths in the `appsettings.json` file.

### Apple music

Need to generate and AppleApi TeamId, KeyId and PrivateKey client secret generated by setting up developer account https://developer.apple.com/documentation/applemusicapi/getting_keys_and_creating_tokens

Config
```
  "AppleApi:TeamId": "",
  "AppleApi:KeyId": "",
  "AppleApi:PrivateKey": "", 

```

### Spotify

Need to generate and client Id and client secret generated by setting up developer account https://developer.spotify.com/documentation

Config
```
  "Spotify:ClientId": "",
  "Spotify:ClientSecret": "",

```

### Azure media services 

Media services implementation in the project will require configuration of few components to work 

- Media services Resource in azure 
- Configured job transform for "AdaptiveStreaming" named "encoding-adaptive-streaming-transform"
- Storage connection
- Event Grid System Topic
- Event Subscription Webhook set to  "{admin-api-url}/webhook/azureeventgrid/job-status-changed" with events: Job scheduled, Job processing, Job finished, Job canceled, Job errored

Config
```
  // Storage connection string
  "AzureStorage:ConnectionString": "",

  // Aad
  "AzureMediaServices:AadClientId": "",
  "AzureMediaServices:AadSecret": "",
  "AzureMediaServices:AadTenantDomain": "",
  "AzureMediaServices:AadTenantId": "",
  "AzureMediaServices:AccountName": "",
  "AzureMediaServices:ArmEndpoint": "https://management.azure.com",

  // Event grid
  "AzureMediaServices:EventGridQueryKey": "",
  "AzureMediaServices:EventGridSubscriptionName": "",

  // General Azure configuration  
  "AzureMediaServices:Location": "", - Resource Group location 
  "AzureMediaServices:ResourceGroup": "", - Azure Resource Group
  "AzureMediaServices:SubscriptionId": ""  - Azure subscription id Group

```

### Jwt

Update `Auth:Jwt:Audience` and `Auth:Jwt:Issuer` to real website address instead of `localhost`.
Update `Auth:Jwt:TokenExpirationTime` to required values.

### Swagger

To enable Swagger (`swagger.json` file and UI), set `EnableSwagger` to `true`.

### Logging

#### AzureBlobStorage

If you want API to send logs to AzureBlobStorage (assuming that you have one configured), then:

   - set connection string under `Serilog:WriteTo:3:Args:connectionString`

#### Application Insights

If you want API to send logs to Application Insights (assuming you have one already created and enabled in app service), then:

  - set instrumentation key under `APPINSIGHTS_INSTRUMENTATIONKEY` 
  - set connection string under `APPLICATIONINSIGHTS_CONNECTION_STRING`
  
### KeyVault

Some secrets are secured with Azure KeyVault service to which a connection needs to be provided
